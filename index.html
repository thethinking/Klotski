<!doctype html>
<html lang='en'>

<head>
    <title>Klotski Puzzle</title>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">

    <style>
        body {
            width: 100%;
            height:100%;          
            text-align: center;
            margin: 0px auto;
            padding: 2px;
            color: #fff;
            background: #458588;
            font-family: 'Courier New', monospace;
            font-size: 10px;
        }

        #bar {
            text-align: left;
            background: #073642;
            padding: 3px;
            margin: 3px 5px;
            line-height: 20px;
            width: 340px;
        }

        #bar span {
            display: inline-block;
        }

        span.button {
            cursor: pointer;
            padding: 0px 8px;
        }

        #bar span.button {
            background: #93a1a1;

        }

        #rLbl,
        #sLbl {
            width: 45px;
            margin: 0px 3px;
        }

        #board {
            margin: 2px 5px;
            background: #eee8d5;
        }

        #history {
            text-align: left;
            background: #073642;
            padding: 5px;
            margin: 2px 5px;
            width: 330px;
            line-height: 24px;
            max-height:150px;
            overflow:auto;
        }

        #history span.button {
            float: right;
            color: #000;
            background: #ccc;
        }

        #history ul {
            padding: 0;
        }

        #history ul li {
            list-style-type: none;
            margin: 3px;
        }
    </style>
</head>

<body>

    <div id='bar'>
        <span title='First' class='button' onclick='selectRound(Number.NEGATIVE_INFINITY)'>|&#9668;&#9668;</span>
        <span title='Prev' class='button' onclick='selectRound(-1)'>&#9668;&#9668;</span>
        <span id='rLbl'>R: 001</span>
        <span title='Next' class='button' onclick='selectRound(1)'>&#9658;&#9658;</span>
        <span title='Last' class='button' onclick='selectRound(Number.POSITIVE_INFINITY)'>&#9658;&#9658;|</span>
        <div style='float:right;'>
            <span id='sLbl'>S: 0</span>
            <span id='rBtn' title="Reset" class='button' onclick='reset()'>RESET</span>
        </div>
    </div>

    <canvas id='board' width='341' height='426'></canvas>

    <div id='history'>
        <span>RECORD:</span><span class='button' style='float: right'
            onclick='javascript:if(true==confirm("Delete all records?"))clearStorage();'>Delete</span>
        <ul id='records'></ul>

    </div>

    <script>

        'use strict';

        const UNIT = 85;
        const THRESHOLD = 500;
        const Board = document.getElementById('board');
        const RoundLabel = document.getElementById('rLbl');
        const StepLabel = document.getElementById('sLbl');
        const RecordList = document.getElementById('records');
        const Context = Board.getContext('2d');
        const BW = [0, 1, 1, 2, 2];
        const BH = [0, 1, 2, 1, 2];


        const DATA = [
            [2, 4, 4, 2, 2, 4, 4, 2, 2, 3, 3, 2, 2, 1, 1, 2, 1, 0, 0, 1],
            [2, 4, 4, 2, 2, 4, 4, 2, 1, 3, 3, 1, 2, 1, 1, 2, 2, 0, 0, 2],
            [0, 4, 4, 0, 2, 4, 4, 2, 2, 2, 2, 2, 1, 2, 2, 1, 3, 3, 1, 1],
            [2, 4, 4, 2, 2, 4, 4, 2, 1, 1, 1, 1, 2, 3, 3, 2, 2, 0, 0, 2],
            [1, 4, 4, 1, 2, 4, 4, 2, 2, 3, 3, 2, 2, 1, 1, 2, 2, 0, 0, 2],
            [2, 4, 4, 1, 2, 4, 4, 1, 2, 3, 3, 2, 2, 2, 0, 2, 1, 2, 0, 1],
            [1, 4, 4, 1, 1, 4, 4, 1, 2, 2, 2, 2, 2, 2, 2, 2, 0, 3, 3, 0],
            [1, 4, 4, 1, 2, 4, 4, 2, 2, 2, 2, 2, 1, 2, 2, 1, 0, 3, 3, 0],
            [2, 4, 4, 1, 2, 4, 4, 1, 2, 2, 2, 1, 2, 2, 2, 1, 0, 3, 3, 0],
            [2, 4, 4, 1, 2, 4, 4, 1, 2, 3, 3, 2, 2, 1, 2, 2, 0, 1, 2, 0],
            [2, 4, 4, 1, 2, 4, 4, 1, 2, 3, 3, 1, 2, 2, 2, 1, 0, 2, 2, 0],
            [1, 4, 4, 1, 1, 4, 4, 1, 0, 3, 3, 0, 2, 2, 2, 2, 2, 2, 2, 2],
            [2, 4, 4, 1, 2, 4, 4, 1, 3, 3, 1, 1, 2, 3, 3, 2, 2, 0, 0, 2],
            [2, 4, 4, 2, 2, 4, 4, 2, 1, 2, 0, 1, 1, 2, 0, 1, 3, 3, 3, 3],
            [2, 4, 4, 1, 2, 4, 4, 1, 2, 3, 3, 2, 2, 3, 3, 2, 1, 0, 0, 1],
            [2, 4, 4, 2, 2, 4, 4, 2, 3, 3, 3, 3, 1, 2, 0, 1, 1, 2, 0, 1],
            [2, 4, 4, 2, 2, 4, 4, 2, 1, 3, 3, 1, 1, 3, 3, 1, 0, 3, 3, 0],
            [1, 4, 4, 2, 1, 4, 4, 2, 2, 3, 3, 1, 2, 3, 3, 1, 0, 3, 3, 0],
            [2, 4, 4, 2, 2, 4, 4, 2, 1, 3, 3, 1, 3, 3, 3, 3, 1, 0, 0, 1],
            [2, 4, 4, 1, 2, 4, 4, 1, 3, 3, 3, 3, 3, 3, 3, 3, 1, 0, 0, 1],
            [1, 4, 4, 1, 1, 4, 4, 1, 2, 0, 3, 3, 2, 0, 3, 3, 3, 3, 3, 3],
            [2, 4, 4, 2, 2, 4, 4, 2, 3, 3, 3, 3, 1, 3, 3, 1, 1, 0, 0, 1],
            [1, 4, 4, 1, 1, 4, 4, 1, 0, 3, 3, 0, 2, 2, 2, 2, 2, 2, 2, 2],
            [1, 4, 4, 1, 2, 4, 4, 2, 2, 1, 1, 2, 2, 3, 3, 2, 2, 0, 0, 2],
            [1, 4, 4, 2, 1, 4, 4, 2, 3, 3, 2, 2, 1, 1, 2, 2, 0, 3, 3, 0],
            [1, 4, 4, 2, 1, 4, 4, 2, 2, 2, 1, 1, 2, 2, 3, 3, 0, 3, 3, 0],
            [1, 4, 4, 1, 2, 4, 4, 2, 2, 3, 3, 2, 1, 3, 3, 1, 0, 3, 3, 0],
            [1, 4, 4, 1, 1, 4, 4, 1, 2, 2, 3, 3, 2, 2, 3, 3, 0, 3, 3, 0],
            [2, 4, 4, 1, 2, 4, 4, 1, 1, 3, 3, 1, 3, 3, 3, 3, 0, 3, 3, 0],
            [1, 4, 4, 1, 2, 4, 4, 1, 2, 1, 3, 3, 3, 3, 3, 3, 0, 3, 3, 0],
            [2, 3, 3, 2, 2, 1, 1, 2, 0, 4, 4, 0, 1, 4, 4, 1, 3, 3, 3, 3],
            [2, 1, 1, 2, 2, 4, 4, 2, 1, 4, 4, 2, 2, 3, 3, 2, 2, 0, 0, 1],
            [1, 1, 4, 4, 3, 3, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 0, 0, 1, 1],
            [3, 3, 3, 3, 2, 4, 4, 2, 2, 4, 4, 2, 1, 3, 3, 1, 1, 0, 0, 1],
            [2, 4, 4, 2, 2, 4, 4, 2, 2, 3, 3, 1, 2, 3, 3, 1, 1, 0, 0, 1],
            [4, 4, 2, 2, 4, 4, 2, 2, 3, 3, 3, 3, 1, 3, 3, 1, 1, 0, 0, 1],
            [4, 4, 3, 3, 4, 4, 2, 1, 2, 2, 2, 1, 2, 2, 1, 1, 0, 3, 3, 0],
            [1, 2, 2, 2, 1, 2, 2, 2, 3, 3, 1, 1, 3, 3, 4, 4, 0, 0, 4, 4],
            [2, 4, 4, 2, 2, 4, 4, 2, 2, 2, 1, 2, 2, 2, 1, 2, 1, 0, 0, 1],
            [3, 3, 4, 4, 3, 3, 4, 4, 3, 3, 3, 3, 1, 0, 1, 2, 1, 0, 1, 2],
            [4, 4, 1, 2, 4, 4, 1, 2, 3, 3, 3, 3, 3, 3, 3, 3, 0, 0, 1, 1],
            [4, 4, 2, 2, 4, 4, 2, 2, 3, 3, 1, 1, 2, 2, 1, 1, 2, 2, 0, 0],
            [4, 4, 3, 3, 4, 4, 3, 3, 2, 2, 3, 3, 2, 2, 1, 1, 1, 0, 0, 1],
            [2, 2, 1, 1, 2, 2, 2, 1, 3, 3, 2, 1, 3, 3, 4, 4, 0, 0, 4, 4],
            [1, 1, 1, 2, 4, 4, 2, 2, 4, 4, 2, 2, 0, 3, 3, 2, 0, 1, 3, 3],
            [1, 3, 3, 1, 2, 4, 4, 2, 2, 4, 4, 2, 1, 3, 3, 1, 0, 3, 3, 0],
            [1, 3, 3, 1, 2, 4, 4, 2, 2, 4, 4, 2, 1, 0, 0, 1, 3, 3, 3, 3],
            [4, 4, 3, 3, 4, 4, 3, 3, 0, 0, 1, 1, 2, 2, 1, 2, 2, 2, 1, 2],
            [0, 2, 1, 1, 2, 2, 2, 1, 2, 1, 2, 0, 3, 3, 4, 4, 3, 3, 4, 4],
            [4, 4, 1, 1, 4, 4, 3, 3, 3, 3, 3, 3, 1, 3, 3, 0, 3, 3, 1, 0],
            [4, 4, 1, 2, 4, 4, 0, 2, 0, 2, 3, 3, 1, 2, 3, 3, 1, 1, 3, 3],
            [0, 2, 1, 2, 1, 2, 0, 2, 2, 1, 4, 4, 2, 1, 4, 4, 3, 3, 3, 3],
            [2, 2, 1, 1, 2, 2, 2, 2, 4, 4, 2, 2, 4, 4, 2, 1, 0, 1, 2, 0],
            [0, 4, 4, 2, 1, 4, 4, 2, 2, 3, 3, 2, 2, 2, 0, 2, 1, 2, 1, 1],
            [4, 4, 1, 1, 4, 4, 3, 3, 3, 3, 1, 0, 1, 2, 3, 3, 0, 2, 3, 3],
            [2, 2, 2, 1, 2, 2, 2, 1, 3, 3, 1, 1, 3, 3, 4, 4, 0, 0, 4, 4],
            [0, 2, 2, 2, 0, 2, 2, 2, 1, 1, 1, 1, 4, 4, 3, 3, 4, 4, 3, 3],
            [2, 2, 1, 2, 2, 2, 1, 2, 3, 3, 1, 1, 3, 3, 4, 4, 0, 0, 4, 4],
            [3, 3, 2, 1, 1, 1, 2, 2, 0, 4, 4, 2, 1, 4, 4, 2, 3, 3, 0, 2],
            [2, 1, 1, 0, 2, 2, 4, 4, 0, 2, 4, 4, 2, 1, 3, 3, 2, 3, 3, 1],
            [0, 1, 2, 1, 4, 4, 2, 2, 4, 4, 1, 2, 1, 3, 3, 2, 0, 3, 3, 2],
            [0, 1, 1, 1, 4, 4, 2, 2, 4, 4, 2, 2, 3, 3, 2, 1, 3, 3, 2, 0],
            [0, 4, 4, 1, 2, 4, 4, 1, 2, 1, 3, 3, 2, 1, 3, 3, 2, 0, 3, 3],
            [4, 4, 1, 1, 4, 4, 2, 1, 3, 3, 2, 1, 3, 3, 2, 0, 3, 3, 2, 0],
            [4, 4, 2, 2, 4, 4, 2, 2, 1, 1, 3, 3, 1, 1, 2, 2, 0, 0, 2, 2],
            [1, 3, 3, 1, 2, 3, 3, 2, 2, 4, 4, 2, 1, 4, 4, 1, 0, 3, 3, 0],
            [4, 4, 1, 2, 4, 4, 0, 2, 1, 0, 3, 3, 1, 2, 3, 3, 1, 2, 3, 3],
            [4, 4, 1, 1, 4, 4, 1, 2, 0, 0, 2, 2, 3, 3, 2, 2, 1, 3, 3, 2],
            [1, 4, 4, 2, 1, 4, 4, 2, 1, 3, 3, 2, 1, 3, 3, 2, 0, 3, 3, 0],
            [3, 3, 4, 4, 3, 3, 4, 4, 3, 3, 2, 2, 0, 0, 2, 2, 1, 1, 1, 1],
            [2, 2, 1, 1, 2, 2, 1, 1, 2, 2, 3, 3, 2, 2, 4, 4, 0, 0, 4, 4],
            [1, 4, 4, 1, 2, 4, 4, 1, 2, 0, 0, 2, 1, 3, 3, 2, 3, 3, 3, 3],
            [0, 1, 1, 0, 4, 4, 1, 2, 4, 4, 2, 2, 3, 3, 2, 2, 1, 3, 3, 2],
            [1, 4, 4, 1, 0, 4, 4, 2, 1, 3, 3, 2, 0, 2, 3, 3, 1, 2, 3, 3],
            [2, 0, 4, 4, 2, 1, 4, 4, 3, 3, 2, 1, 3, 3, 2, 1, 0, 3, 3, 1],
            [4, 4, 2, 1, 4, 4, 2, 0, 1, 1, 3, 3, 2, 0, 3, 3, 2, 3, 3, 1],
            [4, 4, 1, 1, 4, 4, 1, 2, 3, 3, 2, 2, 0, 1, 2, 2, 0, 3, 3, 2],
            [2, 1, 1, 2, 2, 0, 1, 2, 2, 1, 3, 3, 2, 0, 3, 3, 3, 3, 3, 3],
            [2, 1, 4, 4, 2, 0, 4, 4, 3, 3, 1, 1, 0, 3, 3, 2, 1, 3, 3, 2],
            [4, 4, 0, 0, 4, 4, 1, 2, 1, 1, 1, 2, 3, 3, 2, 2, 3, 3, 2, 2],
            [1, 1, 1, 1, 0, 3, 3, 0, 2, 4, 4, 2, 2, 4, 4, 2, 3, 3, 3, 3],
            [0, 4, 4, 1, 1, 4, 4, 2, 3, 3, 0, 2, 2, 1, 3, 3, 2, 3, 3, 1],
            [4, 4, 0, 1, 4, 4, 1, 1, 2, 1, 3, 3, 2, 3, 3, 2, 3, 3, 0, 2],
            [1, 4, 4, 1, 0, 4, 4, 1, 2, 0, 3, 3, 2, 3, 3, 2, 3, 3, 1, 2],
            [0, 4, 4, 0, 2, 4, 4, 2, 2, 3, 3, 2, 3, 3, 3, 3, 1, 1, 1, 1],
            [2, 4, 4, 2, 2, 4, 4, 2, 3, 3, 0, 1, 1, 1, 3, 3, 3, 3, 0, 1],
            [2, 4, 4, 2, 2, 4, 4, 2, 1, 1, 3, 3, 1, 3, 3, 0, 3, 3, 0, 1],
            [4, 4, 2, 1, 4, 4, 2, 1, 2, 3, 3, 1, 2, 3, 3, 1, 0, 3, 3, 0],
            [1, 1, 1, 2, 2, 4, 4, 2, 2, 4, 4, 1, 3, 3, 3, 3, 0, 3, 3, 0],
            [2, 0, 1, 2, 2, 4, 4, 2, 1, 4, 4, 0, 3, 3, 3, 3, 1, 1, 3, 3],
            [0, 4, 4, 0, 2, 4, 4, 1, 2, 3, 3, 1, 1, 3, 3, 2, 1, 3, 3, 2],
            [4, 4, 1, 0, 4, 4, 1, 1, 2, 1, 3, 3, 2, 3, 3, 0, 3, 3, 3, 3],
            [1, 1, 2, 2, 1, 1, 2, 2, 4, 4, 0, 2, 4, 4, 0, 2, 3, 3, 3, 3],
            [1, 2, 4, 4, 1, 2, 4, 4, 3, 3, 1, 2, 3, 3, 2, 2, 1, 0, 2, 0],
            [1, 4, 4, 2, 1, 4, 4, 2, 1, 3, 3, 2, 1, 0, 2, 2, 3, 3, 2, 0],
            [2, 1, 2, 2, 2, 0, 2, 2, 0, 4, 4, 1, 1, 4, 4, 1, 3, 3, 3, 3],
            [1, 2, 0, 1, 1, 2, 0, 1, 2, 4, 4, 2, 2, 4, 4, 2, 3, 3, 3, 3],
            [2, 2, 0, 2, 2, 2, 0, 2, 1, 4, 4, 1, 1, 4, 4, 1, 3, 3, 3, 3],
            [2, 1, 3, 3, 2, 4, 4, 0, 1, 4, 4, 1, 0, 3, 3, 1, 3, 3, 3, 3],
            [3, 3, 0, 2, 0, 4, 4, 2, 1, 4, 4, 1, 3, 3, 3, 3, 1, 3, 3, 1],
            [3, 3, 1, 1, 3, 3, 4, 4, 1, 2, 4, 4, 0, 2, 3, 3, 3, 3, 1, 0],
            [3, 3, 1, 1, 1, 2, 4, 4, 0, 2, 4, 4, 3, 3, 1, 0, 3, 3, 3, 3],
            [1, 0, 1, 2, 4, 4, 1, 2, 4, 4, 2, 2, 3, 3, 2, 2, 0, 1, 3, 3],
            [0, 3, 3, 0, 1, 3, 3, 1, 2, 4, 4, 2, 2, 4, 4, 2, 1, 3, 3, 1],
            [1, 0, 0, 1, 3, 3, 3, 3, 2, 4, 4, 2, 2, 4, 4, 2, 1, 3, 3, 1],
            [1, 4, 4, 2, 1, 4, 4, 2, 1, 1, 3, 3, 3, 3, 2, 2, 0, 0, 2, 2],
            [4, 4, 1, 1, 4, 4, 1, 1, 3, 3, 0, 0, 2, 2, 2, 2, 2, 2, 2, 2],
            [0, 0, 4, 4, 3, 3, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1],
            [0, 4, 4, 0, 1, 4, 4, 1, 1, 1, 3, 3, 2, 2, 3, 3, 2, 2, 3, 3],
            [2, 4, 4, 0, 2, 4, 4, 0, 3, 3, 1, 1, 3, 3, 3, 3, 3, 3, 1, 1],
            [1, 4, 4, 0, 1, 4, 4, 0, 3, 3, 3, 3, 1, 1, 3, 3, 3, 3, 3, 3],
            [1, 4, 4, 0, 1, 4, 4, 0, 3, 3, 3, 3, 3, 3, 2, 1, 3, 3, 2, 1],
            [0, 0, 4, 4, 3, 3, 4, 4, 3, 3, 3, 3, 1, 1, 3, 3, 1, 1, 3, 3],
            [1, 4, 4, 0, 1, 4, 4, 0, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 3, 3],
            [1, 4, 4, 0, 1, 4, 4, 0, 1, 1, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3],
            [1, 4, 4, 0, 1, 4, 4, 0, 1, 1, 3, 3, 2, 2, 2, 2, 2, 2, 2, 2],
            [2, 4, 4, 0, 2, 4, 4, 0, 1, 1, 3, 3, 2, 2, 3, 3, 2, 2, 1, 1],
            [2, 4, 4, 0, 2, 4, 4, 0, 1, 1, 1, 1, 2, 2, 3, 3, 2, 2, 3, 3],
            [2, 4, 4, 0, 2, 4, 4, 0, 2, 2, 1, 1, 2, 2, 3, 3, 3, 3, 1, 1],
            [2, 4, 4, 0, 2, 4, 4, 0, 3, 3, 1, 1, 2, 2, 3, 3, 2, 2, 1, 1],
            [1, 4, 4, 0, 1, 4, 4, 0, 3, 3, 3, 3, 1, 1, 2, 2, 3, 3, 2, 2],
            [0, 0, 4, 4, 3, 3, 4, 4, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 3, 3],
            [2, 4, 4, 0, 2, 4, 4, 0, 3, 3, 1, 1, 1, 1, 3, 3, 3, 3, 3, 3],
            [2, 4, 4, 0, 2, 4, 4, 0, 2, 2, 3, 3, 2, 2, 1, 1, 3, 3, 1, 1],
            [2, 4, 4, 0, 2, 4, 4, 0, 3, 3, 1, 1, 2, 2, 1, 1, 2, 2, 3, 3],
            [1, 4, 4, 0, 1, 4, 4, 0, 3, 3, 2, 2, 3, 3, 2, 2, 1, 1, 3, 3],
            [0, 4, 4, 0, 1, 4, 4, 1, 1, 1, 3, 3, 3, 3, 2, 2, 3, 3, 2, 2],
            [2, 4, 4, 0, 2, 4, 4, 0, 3, 3, 1, 1, 3, 3, 3, 3, 1, 1, 3, 3],
            [1, 3, 3, 2, 1, 1, 2, 2, 4, 4, 2, 2, 4, 4, 0, 2, 0, 1, 3, 3],
            [0, 1, 3, 3, 4, 4, 0, 2, 4, 4, 2, 2, 1, 1, 2, 2, 1, 3, 3, 2],
            [4, 4, 1, 0, 4, 4, 1, 1, 2, 1, 3, 3, 2, 2, 3, 3, 0, 2, 3, 3],
            [1, 4, 4, 1, 1, 4, 4, 1, 2, 3, 3, 2, 2, 3, 3, 2, 0, 3, 3, 0],
            [1, 4, 4, 1, 2, 4, 4, 2, 2, 3, 3, 2, 3, 3, 3, 3, 0, 1, 1, 0],
            [4, 4, 0, 2, 4, 4, 1, 2, 3, 3, 2, 1, 2, 0, 2, 1, 2, 3, 3, 1],
            [4, 4, 0, 2, 4, 4, 0, 2, 2, 3, 3, 1, 2, 1, 2, 1, 3, 3, 2, 1],
            [2, 4, 4, 1, 2, 4, 4, 1, 2, 1, 2, 2, 2, 1, 2, 2, 0, 0, 3, 3],
            [2, 4, 4, 1, 2, 4, 4, 1, 0, 0, 3, 3, 2, 1, 2, 2, 2, 1, 2, 2],
            [4, 4, 1, 2, 4, 4, 1, 2, 0, 0, 3, 3, 1, 2, 2, 2, 1, 2, 2, 2],
            [4, 4, 1, 1, 4, 4, 3, 3, 0, 0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 1],
            [4, 4, 0, 1, 4, 4, 0, 1, 2, 2, 3, 3, 2, 2, 1, 2, 3, 3, 1, 2],
            [4, 4, 0, 1, 4, 4, 0, 1, 2, 1, 3, 3, 2, 1, 2, 2, 3, 3, 2, 2],
            [4, 4, 0, 1, 4, 4, 0, 1, 2, 1, 3, 3, 2, 3, 3, 2, 3, 3, 1, 2],
            [4, 4, 0, 1, 4, 4, 0, 1, 2, 1, 3, 3, 2, 3, 3, 2, 1, 3, 3, 2],
            [1, 2, 1, 1, 1, 2, 0, 0, 3, 3, 4, 4, 3, 3, 4, 4, 3, 3, 3, 3],
            [1, 1, 4, 4, 3, 3, 4, 4, 2, 1, 3, 3, 2, 1, 3, 3, 0, 0, 3, 3],
            [3, 3, 4, 4, 2, 1, 4, 4, 2, 1, 3, 3, 0, 1, 3, 3, 0, 1, 3, 3],
            [2, 1, 3, 3, 2, 1, 1, 1, 3, 3, 4, 4, 3, 3, 4, 4, 3, 3, 0, 0],
            [1, 1, 3, 3, 3, 3, 4, 4, 2, 1, 4, 4, 2, 1, 3, 3, 0, 0, 3, 3],
            [2, 2, 4, 4, 2, 2, 4, 4, 1, 0, 1, 0, 2, 3, 3, 2, 2, 1, 1, 2],
            [2, 4, 4, 2, 2, 4, 4, 2, 2, 1, 1, 0, 2, 3, 3, 2, 0, 1, 1, 2],
            [2, 2, 2, 2, 2, 2, 2, 2, 0, 4, 4, 0, 1, 4, 4, 1, 3, 3, 1, 1],
            [2, 0, 4, 4, 2, 2, 4, 4, 1, 2, 2, 0, 1, 1, 2, 2, 3, 3, 1, 2],
            [4, 4, 1, 1, 4, 4, 3, 3, 1, 1, 3, 3, 3, 3, 2, 2, 0, 0, 2, 2],
            [4, 4, 1, 1, 4, 4, 3, 3, 0, 3, 3, 1, 2, 3, 3, 2, 2, 0, 1, 2],
            [2, 1, 3, 3, 2, 4, 4, 1, 1, 4, 4, 2, 3, 3, 1, 2, 0, 3, 3, 0],
            [4, 4, 2, 2, 4, 4, 2, 2, 0, 1, 0, 1, 2, 2, 3, 3, 2, 2, 1, 1],
            [2, 4, 4, 1, 2, 4, 4, 2, 3, 3, 1, 2, 3, 3, 0, 0, 1, 1, 3, 3],
            [1, 1, 3, 3, 1, 2, 4, 4, 0, 2, 4, 4, 0, 1, 3, 3, 3, 3, 3, 3],
            [0, 2, 2, 2, 1, 2, 2, 2, 0, 1, 1, 1, 4, 4, 3, 3, 4, 4, 3, 3],
            [1, 1, 2, 0, 1, 1, 2, 2, 4, 4, 2, 2, 4, 4, 2, 0, 3, 3, 3, 3],
            [4, 4, 0, 2, 4, 4, 2, 2, 0, 1, 2, 1, 3, 3, 1, 2, 3, 3, 1, 2],
            [2, 2, 1, 1, 2, 2, 3, 3, 2, 4, 4, 0, 2, 4, 4, 1, 0, 3, 3, 1],
            [1, 1, 0, 1, 4, 4, 2, 2, 4, 4, 2, 2, 3, 3, 0, 2, 3, 3, 1, 2],
            [4, 4, 3, 3, 4, 4, 1, 1, 0, 1, 1, 0, 2, 2, 2, 2, 2, 2, 2, 2],
            [1, 2, 2, 0, 1, 2, 2, 1, 4, 4, 2, 1, 4, 4, 2, 0, 3, 3, 3, 3],
            [2, 0, 4, 4, 2, 1, 4, 4, 3, 3, 1, 2, 3, 3, 1, 2, 0, 1, 3, 3],
            [2, 2, 2, 1, 2, 2, 2, 1, 4, 4, 3, 3, 4, 4, 0, 0, 3, 3, 1, 1],
            [3, 3, 1, 1, 4, 4, 0, 0, 4, 4, 3, 3, 2, 2, 2, 1, 2, 2, 2, 1],
            [4, 4, 2, 0, 4, 4, 2, 0, 1, 2, 3, 3, 2, 2, 1, 2, 2, 1, 1, 2],
            [2, 2, 1, 1, 2, 2, 4, 4, 1, 1, 4, 4, 2, 2, 3, 3, 2, 2, 0, 0],
            [2, 2, 0, 0, 2, 2, 3, 3, 1, 1, 4, 4, 2, 2, 4, 4, 2, 2, 1, 1],
            [0, 2, 2, 1, 2, 2, 2, 1, 2, 4, 4, 1, 2, 4, 4, 0, 2, 1, 3, 3],
            [4, 4, 1, 2, 4, 4, 2, 2, 2, 1, 2, 1, 2, 2, 3, 3, 0, 2, 1, 0],
            [1, 4, 4, 2, 2, 4, 4, 2, 2, 2, 2, 1, 0, 2, 2, 0, 1, 1, 3, 3],
            [2, 4, 4, 2, 2, 4, 4, 2, 3, 3, 3, 3, 0, 1, 1, 0, 3, 3, 1, 1],
            [4, 4, 2, 2, 4, 4, 2, 2, 2, 1, 1, 0, 2, 1, 1, 0, 3, 3, 3, 3],
            [2, 2, 0, 2, 2, 2, 0, 2, 2, 2, 4, 4, 2, 2, 4, 4, 1, 1, 1, 1],
            [1, 2, 2, 1, 2, 2, 2, 2, 2, 1, 1, 2, 4, 4, 0, 0, 4, 4, 3, 3],
            [3, 3, 3, 3, 0, 1, 1, 0, 2, 4, 4, 2, 2, 4, 4, 2, 1, 3, 3, 1],
            [2, 1, 1, 2, 2, 4, 4, 2, 2, 4, 4, 1, 2, 3, 3, 2, 0, 0, 1, 2],
            [0, 1, 1, 0, 2, 3, 3, 2, 2, 4, 4, 2, 1, 4, 4, 1, 3, 3, 3, 3],
            [1, 4, 4, 1, 2, 4, 4, 0, 2, 2, 3, 3, 2, 2, 1, 1, 2, 3, 3, 0],
            [0, 2, 1, 1, 1, 2, 4, 4, 2, 2, 4, 4, 2, 2, 3, 3, 3, 3, 1, 0],
            [1, 4, 4, 0, 1, 4, 4, 0, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1],
            [1, 4, 4, 0, 1, 4, 4, 0, 3, 3, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2],
            [1, 4, 4, 1, 2, 4, 4, 2, 2, 0, 0, 2, 2, 1, 1, 2, 2, 3, 3, 2],
            [2, 1, 3, 3, 2, 4, 4, 1, 2, 4, 4, 1, 2, 2, 0, 2, 0, 2, 1, 2],
            [1, 4, 4, 0, 1, 4, 4, 0, 3, 3, 3, 3, 1, 2, 3, 3, 1, 2, 3, 3],
            [1, 4, 4, 0, 1, 4, 4, 1, 2, 3, 3, 1, 2, 0, 2, 2, 3, 3, 2, 2],
            [2, 1, 1, 2, 2, 4, 4, 2, 2, 4, 4, 2, 2, 3, 3, 2, 1, 1, 0, 0],
            [4, 4, 1, 2, 4, 4, 2, 2, 0, 1, 2, 1, 0, 3, 3, 2, 3, 3, 1, 2],
            [3, 3, 4, 4, 2, 1, 4, 4, 2, 2, 3, 3, 0, 2, 2, 1, 1, 0, 2, 1],
            [1, 0, 2, 2, 4, 4, 2, 2, 4, 4, 0, 2, 3, 3, 1, 2, 1, 1, 3, 3],
            [1, 0, 0, 2, 4, 4, 2, 2, 4, 4, 2, 2, 3, 3, 1, 2, 1, 1, 3, 3],
            [1, 4, 4, 0, 1, 4, 4, 0, 3, 3, 3, 3, 2, 2, 1, 1, 2, 2, 3, 3],
            [2, 3, 3, 1, 2, 4, 4, 2, 2, 4, 4, 2, 2, 2, 1, 1, 0, 2, 1, 0],
            [2, 4, 4, 1, 2, 4, 4, 2, 3, 3, 1, 2, 2, 0, 1, 2, 2, 0, 1, 2],
            [2, 4, 4, 0, 2, 4, 4, 1, 3, 3, 2, 2, 2, 0, 2, 2, 2, 1, 1, 1],
            [0, 1, 1, 0, 3, 3, 3, 3, 2, 4, 4, 2, 2, 4, 4, 2, 1, 3, 3, 1],
            [1, 1, 1, 1, 4, 4, 2, 2, 4, 4, 2, 2, 3, 3, 2, 2, 0, 0, 2, 2],
            [0, 0, 2, 2, 3, 3, 2, 2, 4, 4, 2, 2, 4, 4, 2, 2, 1, 1, 1, 1],
            [4, 4, 3, 3, 4, 4, 1, 2, 2, 1, 0, 2, 2, 1, 3, 3, 3, 3, 1, 0],
            [4, 4, 0, 0, 4, 4, 1, 2, 2, 1, 1, 2, 2, 1, 3, 3, 3, 3, 3, 3],
            [4, 4, 3, 3, 4, 4, 3, 3, 2, 1, 1, 2, 2, 3, 3, 2, 1, 0, 0, 1],
            [4, 4, 3, 3, 4, 4, 3, 3, 2, 1, 1, 2, 2, 0, 0, 2, 1, 3, 3, 1],
            [1, 1, 4, 4, 0, 0, 4, 4, 2, 1, 3, 3, 2, 3, 3, 2, 3, 3, 1, 2],
            [0, 4, 4, 0, 1, 4, 4, 1, 2, 3, 3, 2, 2, 3, 3, 2, 1, 3, 3, 1],
            [1, 3, 3, 2, 2, 4, 4, 2, 2, 4, 4, 2, 1, 3, 3, 2, 0, 1, 1, 0],
            [3, 3, 4, 4, 3, 3, 4, 4, 3, 3, 3, 3, 1, 1, 1, 0, 0, 1, 3, 3],
            [3, 3, 4, 4, 3, 3, 4, 4, 3, 3, 1, 0, 1, 3, 3, 0, 1, 1, 3, 3],
            [3, 3, 4, 4, 3, 3, 4, 4, 1, 2, 1, 2, 1, 2, 1, 2, 0, 0, 3, 3],
            [4, 4, 3, 3, 4, 4, 3, 3, 3, 3, 1, 1, 0, 2, 3, 3, 0, 2, 1, 1],
            [2, 4, 4, 2, 2, 4, 4, 2, 1, 2, 2, 1, 1, 2, 2, 1, 0, 3, 3, 0],
            [0, 1, 1, 0, 3, 3, 1, 1, 4, 4, 3, 3, 4, 4, 2, 2, 3, 3, 2, 2],
            [3, 3, 2, 2, 4, 4, 2, 2, 4, 4, 3, 3, 3, 3, 1, 1, 0, 1, 1, 0],
            [3, 3, 2, 2, 4, 4, 2, 2, 4, 4, 3, 3, 3, 3, 1, 1, 1, 1, 0, 0],
            [2, 1, 4, 4, 2, 1, 4, 4, 3, 3, 1, 1, 2, 3, 3, 2, 2, 0, 0, 2],
            [0, 0, 3, 3, 4, 4, 2, 1, 4, 4, 2, 2, 1, 2, 2, 2, 1, 2, 2, 1],
            [1, 2, 2, 1, 1, 2, 2, 2, 4, 4, 2, 2, 4, 4, 2, 1, 0, 0, 3, 3],
            [3, 3, 2, 0, 4, 4, 2, 0, 4, 4, 2, 1, 1, 2, 2, 2, 1, 2, 1, 2],
            [1, 1, 3, 3, 3, 3, 3, 3, 2, 4, 4, 0, 2, 4, 4, 0, 1, 1, 3, 3],
            [1, 2, 0, 0, 1, 2, 3, 3, 4, 4, 3, 3, 4, 4, 1, 1, 3, 3, 3, 3],
            [3, 3, 3, 3, 4, 4, 3, 3, 4, 4, 1, 1, 2, 0, 3, 3, 2, 1, 0, 1],
            [0, 2, 3, 3, 0, 2, 3, 3, 4, 4, 1, 1, 4, 4, 1, 1, 3, 3, 3, 3],
            [3, 3, 3, 3, 4, 4, 1, 1, 4, 4, 1, 1, 0, 2, 3, 3, 0, 2, 3, 3],
            [3, 3, 3, 3, 2, 0, 0, 1, 2, 4, 4, 1, 1, 4, 4, 1, 3, 3, 3, 3],
            [3, 3, 3, 3, 1, 4, 4, 1, 2, 4, 4, 1, 2, 0, 0, 1, 3, 3, 3, 3],
            [3, 3, 3, 3, 3, 3, 1, 1, 1, 4, 4, 1, 0, 4, 4, 0, 3, 3, 3, 3],
            [3, 3, 3, 3, 0, 4, 4, 0, 1, 4, 4, 1, 3, 3, 1, 1, 3, 3, 3, 3],
            [4, 4, 1, 1, 4, 4, 3, 3, 3, 3, 2, 0, 3, 3, 2, 1, 1, 3, 3, 0],
            [4, 4, 1, 0, 4, 4, 0, 2, 2, 3, 3, 2, 2, 3, 3, 1, 1, 1, 3, 3],
            [2, 2, 3, 3, 2, 2, 4, 4, 1, 2, 4, 4, 1, 2, 3, 3, 0, 1, 1, 0],
            [0, 1, 1, 0, 1, 2, 3, 3, 1, 2, 4, 4, 2, 2, 4, 4, 2, 2, 3, 3],
            [4, 4, 2, 0, 4, 4, 2, 1, 1, 1, 3, 3, 2, 3, 3, 1, 2, 3, 3, 0],
            [4, 4, 2, 0, 4, 4, 2, 2, 1, 0, 1, 2, 2, 3, 3, 2, 2, 1, 1, 2],
            [2, 2, 4, 4, 2, 2, 4, 4, 1, 0, 1, 2, 2, 0, 1, 2, 2, 3, 3, 1],
            [4, 4, 3, 3, 4, 4, 2, 1, 1, 1, 2, 2, 2, 3, 3, 2, 2, 0, 0, 1],
            [2, 0, 0, 1, 2, 3, 3, 2, 1, 1, 2, 2, 4, 4, 2, 1, 4, 4, 3, 3],
            [4, 4, 3, 3, 4, 4, 2, 1, 3, 3, 2, 2, 1, 3, 3, 2, 1, 0, 0, 1],
            [1, 0, 0, 1, 1, 3, 3, 2, 3, 3, 2, 2, 4, 4, 2, 1, 4, 4, 3, 3],
            [4, 4, 3, 3, 4, 4, 1, 2, 1, 1, 2, 2, 1, 2, 2, 2, 0, 2, 0, 2],
            [0, 2, 0, 2, 1, 2, 2, 2, 1, 1, 2, 2, 4, 4, 1, 2, 4, 4, 3, 3],
            [2, 1, 1, 1, 2, 2, 3, 3, 2, 2, 0, 1, 2, 0, 4, 4, 3, 3, 4, 4],
            [3, 3, 4, 4, 2, 0, 4, 4, 2, 2, 0, 1, 2, 2, 3, 3, 2, 1, 1, 1],
            [3, 3, 1, 1, 3, 3, 4, 4, 1, 1, 4, 4, 3, 3, 2, 2, 0, 0, 2, 2],
            [2, 2, 1, 1, 2, 2, 2, 2, 4, 4, 2, 2, 4, 4, 2, 1, 1, 0, 2, 0],
            [1, 1, 1, 2, 4, 4, 2, 2, 4, 4, 2, 2, 1, 3, 3, 2, 0, 0, 3, 3],
            [4, 4, 1, 2, 4, 4, 0, 2, 0, 2, 3, 3, 1, 2, 3, 3, 1, 1, 3, 3],
            [2, 2, 2, 2, 2, 2, 2, 2, 1, 4, 4, 1, 0, 4, 4, 0, 3, 3, 1, 1],
            [4, 4, 0, 2, 4, 4, 1, 2, 0, 1, 2, 1, 3, 3, 2, 2, 3, 3, 1, 2],
            [1, 4, 4, 1, 2, 4, 4, 2, 2, 2, 0, 2, 1, 2, 0, 1, 3, 3, 3, 3],
            [1, 1, 2, 0, 1, 1, 2, 2, 4, 4, 2, 2, 4, 4, 2, 0, 3, 3, 3, 3],
            [0, 0, 2, 2, 3, 3, 2, 2, 1, 1, 2, 2, 4, 4, 2, 2, 4, 4, 1, 1],
            [2, 0, 4, 4, 2, 2, 4, 4, 1, 2, 2, 1, 1, 1, 2, 2, 3, 3, 0, 2]
        ];


        var player, frame, round, roundString, step, path, map, solved, target, startAt;

        function init() {
            startAt = [0, 0];
            Board.addEventListener('touchstart', touchStart);
            Board.addEventListener('touchend', touchEnd);
            player = null;
            frame = 0;
            round = getRound();
            showRecords();
            reset();
        }

        function reset() {
            if (player !== null) {
                stopPlayer();
            }
            target = [-1, -1];
            solved = false;
            step = -1;
            updateStep();
            path = [];
            map = [[0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0]];
            roundString = 'R: ' + ('000' + (parseInt(round) + 1)).slice(-3);
            RoundLabel.innerText = roundString;
            Context.clearRect(0, 0, 4 * UNIT, 5 * UNIT);
            Context.fillStyle = '#fb4934';
            placeBlocks();


        }

        function placeBlocks() {
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 4; col++) {
                    if (map[row][col] != 0) {
                        continue;
                    }
                    map[row][col] = DATA[round][row * 4 + col];
                    if (map[row][col] != 0) {
                        drawBlock(row, col, map[row][col]);
                    }
                    switch (map[row][col]) {
                        case 2:
                            map[row + 1][col] = 2;
                            break;
                        case 3:
                            map[row][col + 1] = 3;
                            break;
                        case 4:
                            map[row + 1][col + 1] = 4;
                            map[row + 1][col] = 4;
                            map[row][col + 1] = 4;
                    }
                }
            }
        }

        function drawBlock(row, col, bType) {
            Context.fillRect(col * UNIT + 1, row * UNIT + 1, BW[bType] * UNIT - 1, BH[bType] * UNIT - 1);
        }

        function clearBlock(row, col, bType) {
            Context.clearRect(col * UNIT + 1, row * UNIT + 1, BW[bType] * UNIT - 1, BH[bType] * UNIT - 1);
        }

        function getRound() {
            let round = JSON.parse(localStorage.getItem('round'));
            return round != null ? parseInt(round) : 0;
        }

        function selectRound(param) {
            round += param;
            if (round < 0) {
                round = 0;
            } else if (round >= DATA.length) {
                round = DATA.length - 1;
            }
            localStorage.setItem('round', round);
            reset();
        }

        function updateStep() {
            StepLabel.innerText = 'S: ' + (++step);
        }

        function logMove(row, col, dir) {
            path.push([row, col, dir]);
        }

        function formatDate(t) {
            let date = new Date(parseInt(t));
            let m = ('0' + (date.getMonth() + 1)).slice(-2);
            let d = ('0' + date.getDate()).slice(-2);
            let h = ('0' + date.getHours()).slice(-2);
            let mm = ('0' + date.getMinutes()).slice(-2);
            return date.getFullYear() + '-' + m + '-' + d + ' ' + h + ':' + mm;
        }

        function showRecords() {
            let recorder = JSON.parse(localStorage.getItem('records'));
            if (recorder != null) {
                if (!Array.isArray(recorder))
                    recorder = [recorder];
                RecordList.innerHTML = '';
                recorder.sort(function (a, b) {
                    if (parseInt(a._r) > parseInt(b._r))
                        return 1;
                    else {
                        return -1;
                    }
                })
                for (let r of recorder) {
                    let round = parseInt(r._r);
                    let msg = '[ROUND:' + (round + 1) + '][STEP:' + r._s + '][' + formatDate(r._t) + ']';
                    msg += '<span class="button" onclick="StartPlayer(' + round + ',this)">&#9658;</span>'
                    let entry = document.createElement('LI')
                    entry.innerHTML = msg;
                    RecordList.appendChild(entry);
                }
            }
        }

        function clearStorage() {
            localStorage.clear();
            RecordList.innerHTML = '';
            reset();
        }

        function StartPlayer(r, btn) {
            if (player !== null && round != r) {
                stopPlayer();
            }
            round = r;
            let key = '_p' + r;
            let p = JSON.parse(localStorage.getItem(key));
            Board.removeEventListener('touchstart', touchStart);
            Board.removeEventListener('touchend', touchEnd);
            if ((btn.innerHTML).charCodeAt() == 9658) {
                btn.innerHTML = '&#10074;&#10074;';
                if (frame == 0) {
                    reset();
                }
                player = setInterval(function () {
                    let tuple = p[frame];
                    switch (tuple[2]) {
                        case 0:
                            moveLeft(tuple[0], tuple[1]);
                            break;
                        case 1:
                            moveUp(tuple[0], tuple[1]);
                            break;
                        case 2:
                            moveRight(tuple[0], tuple[1]);
                            break;
                        case 3:
                            moveDown(tuple[0], tuple[1]);
                            break;
                    }
                    frame++;
                    if (frame == p.length) {
                        stopPlayer();
                    }
                }.bind(this), 300);
            } else {
                btn.innerHTML = '&#9658;';
                clearInterval(player);
            }
        }

        function stopPlayer() {
            clearInterval(player);
            Board.addEventListener('touchstart', touchStart);
            Board.addEventListener('touchend', touchEnd);
            player = null;
            frame = 0;
            let playerButtons = document.querySelectorAll('li span.button')
            for (let btn of playerButtons) {
                if (btn.innerText.charCodeAt != 9658) {
                    btn.innerHTML = '&#9658;';
                }
            }
        }

        function touchStart(event) {
            event.preventDefault();
            startAt = [event.changedTouches[0].clientX, event.changedTouches[0].clientY];
        }

        function touchEnd(event) {
            event.preventDefault();
            if (solved) return;
            let x = event.changedTouches[0].clientX;
            let y = event.changedTouches[0].clientY;
            let startCellCol = parseInt((startAt[0] - Board.offsetLeft) / UNIT);
            let startCellRow = parseInt((startAt[1] - Board.offsetTop) / UNIT);
            let startCellType = map[startCellRow][startCellCol];
            if (startCellType == 0) {
                // touch starts on blank, deal it as move toward blank.
                if (target[0] == -1) {
                    return;
                }
                let targetType = map[target[0]][target[1]];
                if (startCellCol < target[1] && startCellRow >= target[0] && startCellRow < target[0] + BH[targetType]) {
                    moveLeft(target[0], target[1]);
                } else if (startCellCol >= target[1] + BW[targetType] && startCellRow >= target[0] && startCellRow < target[0] + BH[targetType]) {
                    moveRight(target[0], target[1]);
                } else if (startCellRow < target[0] && startCellCol >= target[1] && startCellCol < target[1] + BW[targetType]) {
                    moveUp(target[0], target[1]);
                } else if (startCellRow >= target[0] + BH[targetType] && startCellCol >= target[1] && startCellCol < target[1] + BW[targetType]) {
                    moveDown(target[0], target[1]);
                }
                return;
            }
            target = findBlock(startCellRow, startCellCol, startCellType);
            let squareDistance = (x - startAt[0]) * (x - startAt[0]) - (y - startAt[1]) * (y - startAt[1]);
            if (squareDistance < -THRESHOLD || squareDistance > THRESHOLD) {
                // deal it as drag.
                if ((x - startAt[0]) * (x - startAt[0]) > (y - startAt[1]) * (y - startAt[1])) {
                    if ((x - startAt[0]) * (x - startAt[0]) <= THRESHOLD)
                        return;
                    if (x < startAt[0]) {
                        moveLeft(target[0], target[1]);
                    } else {
                        moveRight(target[0], target[1]);
                    }
                } else if ((y - startAt[1]) * (y - startAt[1]) > THRESHOLD) {
                    if (y < startAt[1]) {
                        moveUp(target[0], target[1]);
                    } else {
                        moveDown(target[0], target[1]);
                    }
                }
            }
        }

        function check() {
            if (map[3][1] == map[4][2] && map[4][2] == 4) {
                Context.fillStyle = '#780425';
                drawBlock(3, 1, 4);
                Context.fillStyle = '#fabd2f';
                Context.font = "16px 'Courier new'";
                Context.fillText('SOLVED!', 2 * UNIT - 35, 4 * UNIT);
                solved = true;
                let recorder = JSON.parse(localStorage.getItem('records'));
                if (recorder !== null) {
                    if (!Array.isArray(recorder)) {
                        recorder = [recorder];
                    }
                    let find = false;
                    for (let i = 0; i < recorder.length; i++) {
                        if (recorder[i]._r == round) {
                            find = true;
                            if (recorder[i]._s > step) {
                                recorder[i]._s = step;
                                localStorage.setItem('records', JSON.stringify(recorder));
                            }
                        }
                    }
                    if (!find) {
                        recorder.push({ '_r': round, '_s': step, '_t': (new Date().getTime()) })
                        localStorage.setItem('records', JSON.stringify(recorder));
                    }
                } else {
                    localStorage.setItem('records', JSON.stringify({ '_r': round, '_s': step, '_t': (new Date().getTime()) }));
                }
                let key = '_p' + round;
                localStorage.setItem(key, JSON.stringify(path));
                showRecords();
            }
        }

        function findBlock(row, col, bType) {
            if (bType == 1) {
                return [row, col];
            } else if (bType == 2) {
                if (row == 0)
                    return [0, col];
                if (row == 4)
                    return [3, col];
                if (2 != map[row + 1][col])
                    return [row - 1, col];
                if (2 != map[row - 1][col])
                    return [row, col];
                if (row == 1)
                    return [0, col];
                if (row == 3)
                    return [3, col];
                if (map[0][col] == 2)
                    return [2, col];
                return [1, col];
            } else if (bType == 3) {
                if (col == 0)
                    return [row, 0];
                if (col == 3)
                    return [row, 2];
                if (3 != map[row][col - 1])
                    return [row, col];
                if (3 != map[row][col + 1])
                    return [row, col - 1];
                return [row, 2 * (col - 1)];
            } else if (bType == 4) {
                if (col > 0 && 4 == map[row][col - 1]) {
                    if (row > 0 && 4 == map[row - 1][col - 1]) {
                        return [row - 1, col - 1];
                    } else {
                        return [row, col - 1];
                    }
                } else {
                    if (row > 0 && 4 == map[row - 1][col]) {
                        return [row - 1, col];
                    } else {
                        return [row, col];
                    }
                }
            }
            return [-1, -1];
        }

        function moveLeft(row, col) {
            let bType = map[row][col];
            switch (bType) {
                case 1:
                    if (col <= 0 || map[row][col - 1] != 0) {
                        return;
                    }
                    map[row][col] = 0;
                    map[row][col - 1] = 1;
                    break;
                case 2:
                    if (col <= 0 || map[row][col - 1] != map[row + 1][col - 1] || map[row][col - 1] != 0) {
                        return;
                    }
                    map[row][col - 1] = map[row + 1][col - 1] = 2;
                    map[row][col] = map[row + 1][col] = 0;
                    break;
                case 3:
                    if (col <= 0 || map[row][col - 1] != 0) {
                        return;
                    }
                    map[row][col + 1] = 0;
                    map[row][col - 1] = 3;
                    break;
                case 4:
                    if (col <= 0 || map[row][col - 1] != map[row + 1][col - 1] || map[row][col - 1] != 0) {
                        return;
                    }
                    map[row][col - 1] = map[row + 1][col - 1] = 4;
                    map[row][col + 1] = map[row + 1][col + 1] = 0;
            }
            clearBlock(row, col, bType);
            drawBlock(row, col - 1, bType);
            target = [row, col - 1];
            updateStep();
            logMove(row, col, 0);
            if (bType == 4) {
                check();
            }
        }

        function moveUp(row, col) {
            let bType = map[row][col];
            switch (bType) {
                case 1:
                    if (row <= 0 || map[row - 1][col] != 0) {
                        return;
                    }
                    map[row][col] = 0;
                    map[row - 1][col] = 1;
                    break;
                case 2:
                    if (row <= 0 || map[row - 1][col] != 0) {
                        return;
                    }
                    map[row + 1][col] = 0;
                    map[row - 1][col] = 2;
                    break;
                case 3:
                    if (row <= 0 || map[row - 1][col] != map[row - 1][col + 1] || map[row - 1][col + 1] != 0) {
                        return;
                    }
                    map[row - 1][col] = map[row - 1][col + 1] = 3;
                    map[row][col] = map[row][col + 1] = 0;
                    break;
                case 4:
                    if (row <= 0 || map[row - 1][col] != map[row - 1][col + 1] || map[row - 1][col + 1] != 0) {
                        return;
                    }
                    map[row - 1][col] = map[row - 1][col + 1] = 4;
                    map[row + 1][col] = map[row + 1][col + 1] = 0;
            }
            clearBlock(row, col, bType);
            drawBlock(row - 1, col, bType);
            target = [row - 1, col];
            updateStep();
            logMove(row, col, 1);
        }

        function moveRight(row, col) {
            let bType = map[row][col];
            switch (bType) {
                case 1:
                    if (col >= 3 || map[row][col + 1] != 0) {
                        return;
                    }
                    map[row][col] = 0;
                    map[row][col + 1] = 1;
                    break;
                case 2:
                    if (col >= 3 || map[row][col + 1] != map[row + 1][col + 1] || map[row][col + 1] != 0) {
                        return;
                    }
                    map[row][col + 1] = map[row + 1][col + 1] = 2;
                    map[row][col] = map[row + 1][col] = 0;
                    break;
                case 3:
                    if (col >= 2 || map[row][col + 2] != 0) {
                        return;
                    }
                    map[row][col] = 0;
                    map[row][col + 2] = 3;
                    break;
                case 4:
                    if (col >= 2 || map[row][col + 2] != map[row + 1][col + 2] || map[row + 1][col + 2] != 0) {
                        return;
                    }
                    map[row][col + 2] = map[row + 1][col + 2] = 4;
                    map[row][col] = map[row + 1][col] = 0;
            }
            clearBlock(row, col, bType);
            drawBlock(row, col + 1, bType);
            target = [row, col + 1];
            updateStep();
            logMove(row, col, 2);
            if (bType == 4) {
                check();
            }
        }

        function moveDown(row, col) {
            let bType = map[row][col];
            switch (bType) {
                case 1:
                    if (row >= 4 || map[row + 1][col] != 0) {
                        return;
                    }
                    map[row][col] = 0;
                    map[row + 1][col] = 1;
                    break;
                case 2:
                    if (row >= 3 || map[row + 2][col] != 0) {
                        return;
                    }
                    map[row][col] = 0;
                    map[row + 2][col] = 2;
                    break;
                case 3:
                    if (row >= 4 || map[row + 1][col] != map[row + 1][col + 1] || map[row + 1][col + 1] != 0) {
                        return;
                    }
                    map[row + 1][col] = map[row + 1][col + 1] = 3;
                    map[row][col] = map[row][col + 1] = 0;
                    break;
                case 4:
                    if (row >= 3 || map[row + 2][col] != map[row + 2][col + 1] || map[row + 2][col + 1] != 0) {
                        return;
                    }
                    map[row + 2][col] = map[row + 2][col + 1] = 4;
                    map[row][col] = map[row][col + 1] = 0;
            }
            clearBlock(row, col, bType);
            drawBlock(row + 1, col, bType);
            target = [row + 1, col];
            updateStep();
            logMove(row, col, 3);
            if (bType == 4) {
                check();
            }
        }

        init();
    </script>
</body>

</html>
